<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>呼吸ワーク</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #f0f0f0;
            font-family: sans-serif;
        }
        canvas {
            background-color: #fff;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        /*.controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }*/
        .controls {
            display: flex;
            flex-direction: column; /* flex-directionをcolumnに設定 */
            gap: 10px;
            align-items: center;   /* 縦並びになった要素を中央に揃える */
        }
        .controls div {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        #display-row {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        #timer {
            font-size: 2em;
            font-weight: bold;
        }
        #set-counter {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>呼吸ワーク</h1>
    <canvas id="breathingCanvas" width="400" height="400"></canvas>
    <div id="timer-container">
        <div id="display-row">
            <div id="timer">00:00</div>
            <div id="set-counter"></div>
        </div>
        <div class="button-group">
            <button onclick="startAnimation()">スタート</button>
            <button onclick="stopAnimation()">ストップ</button>
        </div>
    </div>
    <div class="controls">
        <div>
            <label for="inhaleTempo">吸気時間 (秒)</label>
            <input type="range" id="inhaleTempo" min="0.5" max="10" step="0.5" value="2">
            <span id="inhaleTempoValue">2.0</span>秒
        </div>
        <div>
            <label for="exhaleTempo">呼気時間 (秒)</label>
            <input type="range" id="exhaleTempo" min="0.5" max="10" step="0.5" value="2">
            <span id="exhaleTempoValue">2.0</span>秒
        </div>
        <div>
            <label for="breathworkDuration">呼吸ワーク時間 (分)</label>
            <input type="range" id="breathworkDuration" min="0.5" max="15" step="0.5" value="3.0">
            <span id="breathworkDurationValue">3.0</span>分
        </div>
        <div>
            <label for="inhaleHoldTime">吸って息止め (秒)</label>
            <input type="range" id="inhaleHoldTime" min="0" max="180" value="60">
            <span id="inhaleHoldTimeValue">60</span>秒
        </div>
        <div>
            <label for="exhaleHoldTime">吐いて息止め (秒)</label>
            <input type="range" id="exhaleHoldTime" min="0" max="180" value="30">
            <span id="exhaleHoldTimeValue">30</span>秒
        </div>
        <div>
            <label for="sets">セット数</label>
            <select id="sets">
                <option value="1">1 セット</option>
                <option value="3" selected>3 セット</option>
                <option value="5">5 セット</option>
            </select>
        </div>
        <div>
            <label for="color">色</label>
            <select id="color">
                <option value="#4CAF50">グリーン</option>
                <option value="#2196F3">ブルー</option>
                <option value="#FF9800">オレンジ</option>
                <option value="#9C27B0">パープル</option>
            </select>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('breathingCanvas');
        const ctx = canvas.getContext('2d');
        const timerDisplay = document.getElementById('timer');
        const setCounterDisplay = document.getElementById('set-counter');

        const inhaleTempoInput = document.getElementById('inhaleTempo');
        const exhaleTempoInput = document.getElementById('exhaleTempo');
        const breathworkDurationInput = document.getElementById('breathworkDuration');
        const inhaleHoldTimeInput = document.getElementById('inhaleHoldTime');
        const exhaleHoldTimeInput = document.getElementById('exhaleHoldTime');
        const setsSelect = document.getElementById('sets');
        const colorSelect = document.getElementById('color');

        const inhaleTempoValueSpan = document.getElementById('inhaleTempoValue');
        const exhaleTempoValueSpan = document.getElementById('exhaleTempoValue');
        const breathworkDurationValueSpan = document.getElementById('breathworkDurationValue');
        const inhaleHoldTimeValueSpan = document.getElementById('inhaleHoldTimeValue');
        const exhaleHoldTimeValueSpan = document.getElementById('exhaleHoldTimeValue');

        let animationFrameId;
        let startTime = null;
        let currentSet = 1;
        let totalSets;
        let currentStage;
        let currentStageStartTime;
        let isAnimating = false;
        let lastBreathStartTimestamp;

        const POST_EXHALE_RECOVERY_TIME = 20;
        const FINAL_RELEASE_TIME = 60;
        let lastAnnouncedStage = null;

        const updateValueDisplays = () => {
            inhaleTempoValueSpan.textContent = parseFloat(inhaleTempoInput.value).toFixed(1);
            exhaleTempoValueSpan.textContent = parseFloat(exhaleTempoInput.value).toFixed(1);
            breathworkDurationValueSpan.textContent = breathworkDurationInput.value;
            inhaleHoldTimeValueSpan.textContent = inhaleHoldTimeInput.value;
            exhaleHoldTimeValueSpan.textContent = exhaleHoldTimeInput.value;
        };
        inhaleTempoInput.oninput = updateValueDisplays;
        exhaleTempoInput.oninput = updateValueDisplays;
        breathworkDurationInput.oninput = updateValueDisplays;
        inhaleHoldTimeInput.oninput = updateValueDisplays;
        exhaleHoldTimeInput.oninput = updateValueDisplays;
        updateValueDisplays();

        // テキスト読み上げ関数
        const speakText = (text) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 1.2; // 読み上げ速度を少し速くする
                speechSynthesis.speak(utterance);
            }
        };

        const drawCircle = (radius, color, fillAlpha = 0.7, text = '') => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, radius, 0, 2 * Math.PI);
            ctx.fillStyle = `${color}${Math.floor(fillAlpha * 255).toString(16).padStart(2, '0')}`;
            ctx.fill();
            ctx.strokeStyle = color;
            ctx.lineWidth = 5;
            ctx.stroke();

            ctx.font = "bold 30px 'Noto Sans JP', sans-serif";
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#333';
            const lines = text.split('\n');
            lines.forEach((line, index) => {
                ctx.fillText(line, canvas.width / 2, canvas.height / 2 + (index * 35) - (lines.length - 1) * 17.5);
            });
        };

        const updateAnimation = (timestamp) => {
            if (!isAnimating) {
                return;
            }

            if (!startTime) {
                startTime = timestamp;
                currentStageStartTime = timestamp;
                lastBreathStartTimestamp = timestamp;
            }

            const elapsedTimeInStage = (timestamp - currentStageStartTime) / 1000;
            const color = colorSelect.value;
            const baseRadius = 50;
            const maxRadius = 150;
            const inhaleTempo = parseFloat(inhaleTempoInput.value);
            const exhaleTempo = parseFloat(exhaleTempoInput.value);
            const breathworkDuration = parseFloat(breathworkDurationInput.value) * 60;
            const inhaleHoldTime = parseFloat(inhaleHoldTimeInput.value);
            const exhaleHoldTime = parseFloat(exhaleHoldTimeInput.value);

            let radius = baseRadius;
            let stageText = '';
            let timerValue = 0;
            
            if (currentStage === 'breathwork') {
                const cycleTime = (timestamp - lastBreathStartTimestamp) / 1000;
                const totalCycleTime = inhaleTempo + exhaleTempo;
                
                if (cycleTime <= inhaleTempo) {
                    radius = baseRadius + (maxRadius - baseRadius) * (cycleTime / inhaleTempo);
                    stageText = '吸って';
                } else if (cycleTime > inhaleTempo && cycleTime <= totalCycleTime) {
                    radius = maxRadius - (maxRadius - baseRadius) * ((cycleTime - inhaleTempo) / exhaleTempo);
                    stageText = '吐いて';
                }
                
                if (cycleTime >= totalCycleTime) {
                    lastBreathStartTimestamp = timestamp;
                }

                if (elapsedTimeInStage >= breathworkDuration) {
                    currentStage = 'inhaleHold';
                    currentStageStartTime = timestamp;
                }
                timerValue = Math.max(0, breathworkDuration - elapsedTimeInStage);
            } else if (currentStage === 'inhaleHold') {
                radius = maxRadius;
                if (elapsedTimeInStage >= inhaleHoldTime) {
                    currentStage = 'exhaleHold';
                    currentStageStartTime = timestamp;
                }
                timerValue = Math.max(0, inhaleHoldTime - elapsedTimeInStage);
                stageText = `吸って息止め\n${Math.max(0, Math.floor(inhaleHoldTime - elapsedTimeInStage))}秒`;
            } else if (currentStage === 'exhaleHold') {
                radius = baseRadius;
                if (elapsedTimeInStage >= exhaleHoldTime) {
                    currentStage = 'postExhaleRecovery';
                    currentStageStartTime = timestamp;
                }
                timerValue = Math.max(0, exhaleHoldTime - elapsedTimeInStage);
                stageText = `吐いて息止め\n${Math.max(0, Math.floor(exhaleHoldTime - elapsedTimeInStage))}秒`;
            } else if (currentStage === 'postExhaleRecovery') {
                radius = baseRadius;
                if (elapsedTimeInStage >= POST_EXHALE_RECOVERY_TIME) {
                    currentSet++;
                    if (currentSet > totalSets) {
                        currentStage = 'release';
                        currentStageStartTime = timestamp;
                    } else {
                        currentStage = 'breathwork';
                        currentStageStartTime = timestamp;
                    }
                    lastBreathStartTimestamp = null;
                }
                timerValue = Math.max(0, POST_EXHALE_RECOVERY_TIME - elapsedTimeInStage);
                stageText = `リカバリータイム\n${Math.max(0, Math.floor(POST_EXHALE_RECOVERY_TIME - elapsedTimeInStage))}秒`;
            } else if (currentStage === 'release') {
                radius = baseRadius + (maxRadius - baseRadius) * (elapsedTimeInStage / FINAL_RELEASE_TIME);
                if (elapsedTimeInStage >= FINAL_RELEASE_TIME) {
                    stopAnimation();
                    return;
                }
                timerValue = Math.max(0, FINAL_RELEASE_TIME - elapsedTimeInStage);
                stageText = `味わいタイム\n${Math.max(0, Math.floor(FINAL_RELEASE_TIME - elapsedTimeInStage))}秒`;
            }

            // 音声読み上げのロジック
            if (lastAnnouncedStage !== currentStage) {
                let speechText = '';
                if (currentStage === 'inhaleHold') {
                    speechText = '吸って息止め';
                } else if (currentStage === 'exhaleHold') {
                    speechText = 'はいて息止め';
                } else if (currentStage === 'postExhaleRecovery') {
                    speechText = '吸って10秒とめたら解放。普通呼吸';
                } else if (currentStage === 'release') {
                    speechText = '体の感覚をゆっくり味わってください';
                }
                if (speechText) {
                    speakText(speechText);
                }
                lastAnnouncedStage = currentStage;
            }

            const minutes = Math.floor(timerValue / 60).toString().padStart(2, '0');
            const seconds = Math.floor(timerValue % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
            setCounterDisplay.textContent = `セット ${currentSet} / ${totalSets}`;

            drawCircle(radius, color, currentStage === 'postExhaleRecovery' ? 0.3 : 0.7, stageText);

            animationFrameId = requestAnimationFrame(updateAnimation);
        };

        const startAnimation = () => {
            if (!isAnimating) {
                isAnimating = true;
                startTime = null;
                currentSet = 1;
                totalSets = parseInt(setsSelect.value);
                currentStage = 'breathwork';
                lastBreathStartTimestamp = null;
                lastAnnouncedStage = null; // リセット
                animationFrameId = requestAnimationFrame(updateAnimation);
            }
        };

        const stopAnimation = () => {
            isAnimating = false;
            cancelAnimationFrame(animationFrameId);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            timerDisplay.textContent = '00:00';
            setCounterDisplay.textContent = '';
            lastAnnouncedStage = null; // リセット
            drawCircle(50, '#4CAF50', 0.7, 'スタート');
        };
        
        drawCircle(50, '#4CAF50', 0.7, 'スタート');
    </script>
</body>
</html>
